<!DOCTYPE html>
<html>
<head>
  <title>View Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Include all existing styles from dashboard -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,400;1,700;1,900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/assets5i/dashboard.css">
  <link rel="stylesheet" href="/assets5i/d.css">
  <link rel="stylesheet" href="/assets0/notify.css">
  <link rel="stylesheet" href="/assets0/custom/custom.css">
  <link rel="stylesheet" href="/assets5i/custom/custom.css">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/wp-user/assets5i/dashboard.css">
  <link rel="stylesheet" href="/wp-user/assets5i/d.css">
  <link rel="stylesheet" href="/wp-user/assets0/notify.css">
  <link rel="stylesheet" href="/wp-user/assets0/custom/custom.css">
  <link rel="stylesheet" href="/wp-user/assets5i/custom/custom.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.6.0/remixicon.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/typography.css">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/css/responsive.css">
  <link rel="stylesheet" type="text/css" href="/nt/ss.css">
  <link rel="stylesheet" type="text/css" href="/nt/as.css">
  <link rel="stylesheet" type="text/css" href="/otassets/otfi.css">
  <style>
    .chat-container {
      max-width: 800px;
      margin: 20px auto;
      background: #1c2526;
      border-radius: 10px;
      padding: 20px;
      color: #fff;
    }
    .chat-box {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #444;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
      background: #171717;
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
    }
    .message.user {
      background: #2a9d8f;
      margin-left: 20%;
      text-align: right;
    }
    .message.admin {
      background: #264653;
      margin-right: 20%;
    }
    .message img {
      max-width: 200px;
      border-radius: 5px;
    }
    .chat-form {
      display: flex;
      gap: 10px;
    }
    .chat-form input[type="text"] {
      flex: 1;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #444;
      background: #171717;
      color: #fff;
    }
    .chat-form input[type="file"] {
      padding: 10px;
    }
    .chat-form button {
      padding: 10px 20px;
      background: #1b55e2;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .chat-form button:hover {
      background: #143db4;
    }
  </style>
</head>
<body style="background-color:black;">
  <section class="content">
    <!-- Include sidebar and navbar from dashboard -->
    <div class="iq-sidebar" style="background-color:#171717;">
      <div class="iq-sidebar-logo d-flex justify-content-between">
        <a href="#" class="header-logo">
          <img src="/images/logo.svg" class="img-fluid rounded-normal" alt="">
        </a>
        <div class="iq-menu-bt-sidebar">
          <div class="iq-menu-bt align-self-center">
            <div class="wrapper-menu">
              <div class="main-circle"><i class="ri-arrow-left-s-line" style="color:#fff;"></i></div>
              <div class="hover-circle"><i class="ri-arrow-right-s-line" style="color:#fff;"></i></div>
            </div>
          </div>
        </div>
      </div>
      <div id="sidebar-scrollbar" data-scrollbar="true" tabindex="-1">
        <div class="scroll-content">
          <nav class="iq-sidebar-menu">
            <ul id="iq-sidebar-toggle" class="iq-menu">
              <li><a href="/adminRoute" class="iq-waves-effect" style="color:#fff;"><i class="ai-home-alt1"></i><span>Admin Dashboard</span></a></li>
              <li><a href="/all-chats" class="iq-waves-effect" style="color:#fff;"><i class="bi bi-chat-dots"></i><span>All Chats</span></a></li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
    <div class="iq-top-navbar" style="background-color:#171717;">
      <div class="iq-navbar-custom">
        <nav class="navbar navbar-expand-lg navbar-light p-0">
          <div class="iq-menu-bt d-flex align-items-center">
            <div class="wrapper-menu">
              <div class="main-circle"><i class="ri-arrow-left-s-line" style="color:#fff;"></i></div>
              <div class="hover-circle"><i class="ri-arrow-right-s-line" style="color:#fff;"></i></div>
            </div>
            <div class="iq-navbar-logo d-flex justify-content-between">
              <a href="#" class="header-logo">
                <img src="/images/favicon.svg" class="img-fluid rounded-normal" alt="">
              </a>
            </div>
          </div>
          <ul class="navbar-list">
            <li class="line-height">
              <a href="#" class="search-toggle iq-waves-effect d-flex align-items-center">
                <img src="/wp-user/assets5i/img/pers.svg" class="profile-img" alt="user">
              </a>
              <div class="iq-sub-dropdown iq-user-dropdown">
                <div class="iq-card shadow-none m-0">
                  <div class="iq-card-body p-0" style="background-color:#171717;">
                    <div class="bg-primary p-3">
                      <h5 class="mb-0 text-white line-height">Admin</h5>
                    </div>
                    <div class="d-inline-block w-100 text-center p-3">
                      <a class="bg-primary iq-sign-btn" href="/logout" role="button">Sign Out<i class="ri-login-box-line ml-2"></i></a>
                    </div>
                  </div>
                </div>
              </div>
            </li>
          </ul>
        </nav>
      </div>
    </div>
    <!-- Chat Content -->
    <div class="chat-container">
      <h2>Chat with <%= chat.user.fullname %></h2>
      <% if (messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>
      <% if (messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      <div class="chat-box" id="chatBox">
        <% chat.messages.forEach(message => { %>
          <div class="message <%= message.sender %>">
            <p><%= message.content %></p>
            <% if (message.image) { %>
              <img src="<%= message.image %>" alt="Chat Image">
            <% } %>
            <small><%= message.timestamp.toLocaleString() %></small>
          </div>
        <% }) %>
      </div>
      <form class="chat-form" id="chatForm" enctype="multipart/form-data">
        <input type="text" name="content" placeholder="Type your response..." required>
        <input type="file" name="chatImage" accept="image/jpeg,image/jpg,image/png">
        <button type="submit">Send</button>
      </form>
    </div>
  </section>
  <!-- Scripts -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
  <script src="/js/jquery.appear.js"></script>
  <script src="/js/countdown.min.js"></script>
  <script src="/js/waypoints.min.js"></script>
  <script src="/js/jquery.counterup.min.js"></script>
  <script src="/js/wow.min.js"></script>
  <script src="/js/apexcharts.js"></script>
  <script src="/js/slick.min.js"></script>
  <script src="/js/select2.min.js"></script>
  <script src="/js/owl.carousel.min.js"></script>
  <script src="/js/jquery.magnific-popup.min.js"></script>
  <script src="/js/smooth-scrollbar.js"></script>
  <script src="/js/lottie.js"></script>
  <script src="/js/core.js"></script>
  <script src="/js/charts.js"></script>
  <script src="/js/animated.js"></script>
  <script src="/js/kelly.js"></script>
  <script src="/js/maps.js"></script>
  <script src="/js/worldLow.js"></script>
  <script src="/js/style-customizer.js"></script>
  <script src="/js/chart-custom.js"></script>
  <script src="/js/custom.js"></script>
  <script src="/assets5i/custom/custom.js"></script>
  <script src="/assets0/notify.js"></script>
  <script src="/assets0/custom/custom.js"></script>
  <script src="/nt/nt.js"></script>
  <script src="/nt/f.js"></script>
  <script src="/otassets/otfi.js"></script>
  <script src="/plugins/sweetalerts/sweetalert2.min.js"></script>
  <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
  <script>
    const socket = io();
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const userId = '<%= chat.user._id %>';

    socket.emit('adminJoin');

    socket.on('newMessage', ({ userId: messageUserId, message }) => {
      if (messageUserId === userId) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender}`;
        messageDiv.innerHTML = `
          <p>${message.content}</p>
          ${message.image ? `<img src="${message.image}" alt="Chat Image">` : ''}
          <small>${new Date(message.timestamp).toLocaleString()}</small>
        `;
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
      }
    });

    chatForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(chatForm);
      const content = formData.get('content');
      const chatImage = formData.get('chatImage');

      if (!content && !chatImage) return;

      if (chatImage && chatImage.size > 0) {
        const response = await fetch('/chat/<%= chat._id %>', {
          method: 'POST',
          body: formData,
        });
        if (response.ok) {
          chatForm.reset();
        }
      } else {
        socket.emit('adminSendMessage', { userId, content });
        chatForm.reset();
      }
    });
  </script>
</body>
</html>